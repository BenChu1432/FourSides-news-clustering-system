# placeUtil.py
import re
from typing import Dict, List, Set, Optional
from unicodedata import normalize as ucnorm

# ---- 基本正規化 ----
def _cjk_norm(s: str) -> str:
    s = ucnorm("NFKC", (s or "").strip())
    # 去空白，保留中文字與數字、拉丁等
    return re.sub(r"\s+", "", s)

# === 你的 enum（完整對齊，作為唯一允許輸出的集合） ===
ALLOWED_PLACES: set[str] = {
    # 台灣縣市
    "台北市","新北市","桃園市","台中市","台南市","高雄市","基隆市","新竹市","嘉義市",
    "宜蘭縣","花蓮縣","台東縣","南投縣","彰化縣","雲林縣","屏東縣","苗栗縣","新竹縣","嘉義縣",
    "澎湖縣","金門縣","連江縣",

    # 核心常見地區
    "香港","中國","美國","加沙","以色列","烏克蘭","歐盟","日本","韓國",
    "台灣",   # NEW: default fallback for domestic
    "澳門",

    # 歐洲（西歐、北歐、南歐、中東歐、巴爾幹）
    "英國","法國","德國","義大利","西班牙","葡萄牙","荷蘭","比利時","盧森堡",
    "瑞士","奧地利","愛爾蘭","丹麥","瑞典","挪威","芬蘭","冰島",
    "波蘭","捷克","匈牙利","斯洛伐克","斯洛維尼亞","克羅埃西亞","羅馬尼亞","保加利亞","希臘",
    "愛沙尼亞","拉脫維亞","立陶宛","白俄羅斯","摩爾多瓦","馬爾他","賽普勒斯","塞爾維亞",
    "波士尼亞與赫塞哥維納","蒙特內哥羅","北馬其頓","阿爾巴尼亞","科索沃","俄羅斯",

    # 北美、大洋洲
    "加拿大","澳大利亞","紐西蘭",

    # 東北亞、東南亞、南亞、中亞
    "北韓","蒙古","新加坡","馬來西亞","印尼","泰國","越南","菲律賓","柬埔寨","寮國","汶萊","東帝汶",
    "印度","巴基斯坦","孟加拉","斯里蘭卡","尼泊爾","不丹","馬爾地夫",
    "哈薩克","烏茲別克","吉爾吉斯","土庫曼","塔吉克",

    # 中東與北非（含以巴周邊）
    "土耳其","伊朗","伊拉克","敘利亞","黎巴嫩","約旦","埃及",
    "沙烏地阿拉伯","阿拉伯聯合大公國","卡達","科威特","巴林","阿曼","也門",
    "巴勒斯坦","約旦河西岸",

    # 拉丁美洲與加勒比
    "墨西哥","巴西","阿根廷","智利","秘魯","哥倫比亞","委內瑞拉","厄瓜多","玻利維亞","烏拉圭","巴拉圭",
    "古巴","多明尼加","海地","瓜地馬拉","薩爾瓦多","宏都拉斯","尼加拉瓜","哥斯大黎加","巴拿馬",
    "牙買加","巴貝多","千里達及托巴哥","巴哈馬",

    # 非洲
    "南非","奈及利亞","衣索比亞","肯亞","坦尚尼亞","烏干達","盧安達","迦納","象牙海岸","塞內加爾",
    "喀麥隆","摩洛哥","阿爾及利亞","突尼西亞","利比亞","蘇丹","南蘇丹","索馬利亞",
    "安哥拉","納米比亞","波札那","尚比亞","辛巴威","剛果民主共和國","剛果共和國","馬達加斯加","模里西斯",

    # 大洋洲與太平洋島國
    "帛琉","所羅門群島","馬紹爾群島","吐瓦魯","諾魯","吉里巴斯","密克羅尼西亞聯邦",
    "巴布亞紐幾內亞","斐濟","薩摩亞","東加","萬那杜",

    # 可選回退
    "國際",
}

# ---- 台灣縣市關鍵字（維持原有規則）----
TW_PATTERNS: dict[str, list[re.Pattern]] = {
    "台北市": [re.compile(r"(台|臺)北(市|$|市政府|市府|市議會|市警|市警局)", re.I)],
    "新北市": [re.compile(r"新北(市|$|市政府|市府|市議會|市警|市警局)", re.I)],
    "桃園市": [re.compile(r"桃園(市|$|市政府|市府|機場)", re.I)],
    "台中市": [re.compile(r"(台|臺)中(市|$|市政府|市府|市警|捷運)", re.I)],
    "台南市": [re.compile(r"(台|臺)南(市|$|市政府|市府|市警)", re.I)],
    "高雄市": [re.compile(r"高雄(市|$|市政府|市府|市警|捷運|山區)", re.I)],
    "基隆市": [re.compile(r"基隆(市|$)", re.I)],
    "新竹市": [re.compile(r"新竹市", re.I)],
    "新竹縣": [re.compile(r"新竹縣", re.I)],
    "嘉義市": [re.compile(r"嘉義市", re.I)],
    "嘉義縣": [re.compile(r"嘉義縣", re.I)],
    "宜蘭縣": [re.compile(r"宜蘭(縣|$)", re.I)],
    "花蓮縣": [re.compile(r"花蓮(縣|$)", re.I)],
    "台東縣": [re.compile(r"(台|臺)東(縣|$)", re.I)],
    "南投縣": [re.compile(r"南投(縣|$)", re.I)],
    "彰化縣": [re.compile(r"彰化(縣|$)", re.I)],
    "雲林縣": [re.compile(r"雲林(縣|$)", re.I)],
    "屏東縣": [re.compile(r"屏東(縣|$)|恆春|墾丁|小墾丁", re.I)],
    "苗栗縣": [re.compile(r"苗栗(縣|$)", re.I)],
    "澎湖縣": [re.compile(r"澎湖(縣|$)|澎湖沿岸|馬公", re.I)],
    "金門縣": [re.compile(r"金門(縣|$)", re.I)],
    "連江縣": [re.compile(r"(連江|馬祖)", re.I)],
}

# 常見細地名 → 所屬縣市（補強台灣內文）
TW_KEYWORD_TO_COUNTY: list[tuple[re.Pattern, str]] = [
    (re.compile(r"(太|臺)麻里"), "台東縣"),
    (re.compile(r"綠島"), "台東縣"),
    (re.compile(r"成功鎮|關山|池上|長濱"), "台東縣"),
    (re.compile(r"恆春|墾丁|車城|枋山|滿州"), "屏東縣"),
    (re.compile(r"恆春半島|小墾丁"), "屏東縣"),
    (re.compile(r"花東|花東縱谷"), "花蓮縣"),  # 也會透過區域展開補上台東縣
    (re.compile(r"大台北|北北基"), "台北市"),     # 仍會透過區域展開補齊新北/基隆
]

# ---- 國際／國家別名（最少保證：中文本名 + 常見別名/英文）----
# 備註：未列入別名者會用「精確字面命中」；下方 alias 只是補強 NER 漏抓與常見縮寫。
COUNTRY_OR_REGION_ALIASES: Dict[str, List[str]] = {
    # 已存在的
    "香港": ["香港","HK","H.K."],
    "澳門": ["澳門","澳门","Macau","Macao"],
    "中國": ["中國","中国","中國大陸","中國大陆","大陸","陆方","陸方","PRC","MainlandChina","Mainland"],
    "美國": ["美國","美国","美方","USA","U.S.","US","UnitedStates","華府","华府","白宮","白宫","美軍","美军","矽谷","硅谷"],
    "日本": ["日本","Japan","東京","东京","大阪","京都","沖繩","冲绳","北海道","名古屋","福岡","福冈"],
    "韓國": ["韓國","韩国","南韓","SouthKorea","Korea","首爾","首尔","釜山","仁川","濟州","济州"],
    "烏克蘭": ["烏克蘭","乌克兰","Ukraine","基輔","基辅","哈爾科夫","哈尔科夫","敖德薩","敖德萨","赫爾松","赫尔松","頓涅茨克","顿涅茨克","盧甘斯克","卢甘斯克"],
    "以色列": ["以色列","Israel","特拉維夫","特拉维夫","耶路撒冷","海法"],
    "加沙": ["加薩","加沙","加薩走廊","加沙走廊","加薩地帶","加沙地帶","Gaza","GazaStrip"],
    "歐盟": ["歐盟","欧洲联盟","歐洲聯盟","EU","E.U.","EuropeanUnion","布魯塞爾","布鲁塞尔","歐盟委員會","歐洲議會"],
    "台灣": ["台灣","台湾","中華民國","RepublicofChina","ROC"],

    # 英國與歐洲西北
    "英國": ["英國","英国","UK","U.K.","Britain","UnitedKingdom","倫敦","伦敦"],
    "法國": ["法國","法国","France","巴黎","Paris"],
    "德國": ["德國","德国","Germany","柏林","Berlin"],
    "義大利": ["義大利","意大利","Italy","羅馬","罗马"],
    "西班牙": ["西班牙","Spain","馬德里","马德里","Barcelona","巴塞隆納","巴塞罗那"],
    "葡萄牙": ["葡萄牙","Portugal","里斯本"],
    "荷蘭": ["荷蘭","荷兰","Netherlands","NL","尼德蘭","尼德兰","阿姆斯特丹"],
    "比利時": ["比利時","比利时","Belgium","布魯塞爾","布鲁塞尔"],
    "盧森堡": ["盧森堡","卢森堡","Luxembourg"],
    "瑞士": ["瑞士","Switzerland","Swiss"],
    "奧地利": ["奧地利","奥地利","Austria","維也納","维也纳"],
    "愛爾蘭": ["愛爾蘭","爱尔兰","Ireland","Eire","Dublin","都柏林"],

    # 北歐
    "丹麥": ["丹麥","丹麦","Denmark","Copenhagen","哥本哈根"],
    "瑞典": ["瑞典","Sweden","Stockholm","斯德哥爾摩"],
    "挪威": ["挪威","Norway","Oslo","奧斯陸","奥斯陆"],
    "芬蘭": ["芬蘭","芬兰","Finland","赫爾辛基","赫尔辛基"],
    "冰島": ["冰島","冰岛","Iceland","雷克雅維克","雷克雅未克"],

    # 中東歐與巴爾幹
    "波蘭": ["波蘭","波兰","Poland","華沙","华沙"],
    "捷克": ["捷克","Czech","Czechia","布拉格"],
    "匈牙利": ["匈牙利","Hungary","布達佩斯","布达佩斯"],
    "斯洛伐克": ["斯洛伐克","Slovakia","布拉提斯拉瓦","布拉迪斯拉发"],
    "斯洛維尼亞": ["斯洛維尼亞","斯洛文尼亚","Slovenia","盧布爾雅那","卢布尔雅那"],
    "克羅埃西亞": ["克羅埃西亞","克罗地亚","克罗埃西亚","Croatia","札格雷布","萨格勒布"],
    "羅馬尼亞": ["羅馬尼亞","罗马尼亚","Romania","布加勒斯特","布加勒斯特"],
    "保加利亞": ["保加利亞","保加利亚","Bulgaria","索菲亞","索非亚"],
    "希臘": ["希臘","希腊","Greece","雅典"],
    "愛沙尼亞": ["愛沙尼亞","爱沙尼亚","Estonia","塔林"],
    "拉脫維亞": ["拉脫維亞","拉脱维亚","Latvia","里加"],
    "立陶宛": ["立陶宛","Lithuania","維爾紐斯","维尔纽斯"],
    "白俄羅斯": ["白俄羅斯","白俄罗斯","Belarus","明斯克"],
    "摩爾多瓦": ["摩爾多瓦","摩尔多瓦","Moldova","基希納烏","基希讷乌","Chisinau"],
    "馬爾他": ["馬爾他","马耳他","Malta"],
    "賽普勒斯": ["賽普勒斯","塞浦路斯","Cyprus"],
    "塞爾維亞": ["塞爾維亞","塞尔维亚","Serbia","貝爾格萊德","贝尔格莱德"],
    "波士尼亞與赫塞哥維納": ["波士尼亞與赫塞哥維納","波黑","BosniaandHerzegovina","Bosnia","Herzegovina","BiH","薩拉熱窩","萨拉热窝"],
    "蒙特內哥羅": ["蒙特內哥羅","黑山","Montenegro","波德里察","波德戈里察"],
    "北馬其頓": ["北馬其頓","北马其顿","NorthMacedonia","馬其頓","马其顿","史高比耶","斯科普里"],
    "阿爾巴尼亞": ["阿爾巴尼亞","阿尔巴尼亚","Albania","地拉那","地拉那"],
    "科索沃": ["科索沃","Kosovo","普里什蒂納","普里什蒂纳"],
    "俄羅斯": ["俄羅斯","俄罗斯","Russia","俄羅斯聯邦","莫斯科","Moscow"],

    # 北美、大洋洲
    "加拿大": ["加拿大","Canada","渥太華","渥太华","Ottawa"],
    "澳大利亞": ["澳大利亞","澳洲","Australia","Sydney","悉尼","Canberra","堪培拉","墨爾本","墨尔本"],
    "紐西蘭": ["紐西蘭","新西兰","NewZealand","NZ","惠靈頓","惠灵顿"],

    # 東北亞、東南亞、南亞、中亞
    "北韓": ["北韓","北朝鮮","朝鮮","朝鲜","NorthKorea","DPRK","平壤"],
    "蒙古": ["蒙古","Mongolia","烏蘭巴托","乌兰巴托"],
    "新加坡": ["新加坡","Singapore","SG"],
    "馬來西亞": ["馬來西亞","马来西亚","Malaysia","MY","吉隆坡"],
    "印尼": ["印尼","印度尼西亞","印度尼西亚","Indonesia","ID","雅加達","雅加达","Jakarta"],
    "泰國": ["泰國","泰国","Thailand","曼谷","Bangkok"],
    "越南": ["越南","Vietnam","河內","河内","Hanoi","胡志明市","HCMC"],
    "菲律賓": ["菲律賓","菲律宾","Philippines","PH","馬尼拉","马尼拉"],
    "柬埔寨": ["柬埔寨","Cambodia","金邊","金边"],
    "寮國": ["寮國","老撾","老挝","Laos","LaoPDR","永珍","万象"],
    "汶萊": ["汶萊","文莱","Brunei"],
    "東帝汶": ["東帝汶","东帝汶","TimorLeste","Timor-Leste"],

    "印度": ["印度","India","IN","新德里","德里"],
    "巴基斯坦": ["巴基斯坦","Pakistan","PK","伊斯蘭馬巴德","伊斯兰堡"],
    "孟加拉": ["孟加拉","Bangladesh","BD","達卡","达卡"],
    "斯里蘭卡": ["斯里蘭卡","斯里兰卡","SriLanka","LK","可倫坡","科伦坡"],
    "尼泊爾": ["尼泊爾","尼泊尔","Nepal","NP","加德滿都","加德满都"],
    "不丹": ["不丹","Bhutan","BT","廷布"],
    "馬爾地夫": ["馬爾地夫","马尔代夫","Maldives","MV","瑪累","马累"],

    "哈薩克": ["哈薩克","哈萨克斯坦","哈萨克","Kazakhstan","KZ","阿斯塔納","阿斯塔纳"],
    "烏茲別克": ["烏茲別克","乌兹别克斯坦","乌兹别克","Uzbekistan","UZ","塔什干"],
    "吉爾吉斯": ["吉爾吉斯","吉尔吉斯斯坦","吉尔吉斯","Kyrgyzstan","KG","比什凱克","比什凯克"],
    "土庫曼": ["土庫曼","土库曼斯坦","土库曼","Turkmenistan","TM","阿什哈巴德"],
    "塔吉克": ["塔吉克","塔吉克斯坦","Tajikistan","TJ","杜尚別","杜尚贝"],

    # 中東與北非
    "土耳其": ["土耳其","Türkiye","Turkey","安卡拉","伊斯坦堡","伊斯坦布尔","伊斯坦堡"],
    "伊朗": ["伊朗","Iran","Tehran","德黑蘭","德黑兰"],
    "伊拉克": ["伊拉克","Iraq","巴格達","巴格达"],
    "敘利亞": ["敘利亞","叙利亚","Syria","大馬士革","大马士革"],
    "黎巴嫩": ["黎巴嫩","Lebanon","貝魯特","贝鲁特"],
    "約旦": ["約旦","约旦","Jordan","安曼"],
    "埃及": ["埃及","Egypt","開羅","开罗"],
    "沙烏地阿拉伯": ["沙烏地阿拉伯","沙特阿拉伯","沙特","SaudiArabia","KSA","利雅德"],
    "阿拉伯聯合大公國": ["阿拉伯聯合大公國","阿聯","阿联酋","阿联","UAE","UnitedArabEmirates","阿布達比","阿布扎比","杜拜","迪拜","Dubai"],
    "卡達": ["卡達","卡塔爾","卡塔尔","Qatar","多哈"],
    "科威特": ["科威特","Kuwait"],
    "巴林": ["巴林","Bahrain","麥納瑪","麦纳麦"],
    "阿曼": ["阿曼","Oman","馬斯喀特","马斯喀特"],
    "也門": ["也門","也门","Yemen","薩那","萨那"],
    "巴勒斯坦": ["巴勒斯坦","Palestine","PA"],
    "約旦河西岸": ["約旦河西岸","西岸","WestBank"],

    # 拉丁美洲與加勒比
    "墨西哥": ["墨西哥","Mexico","MX","墨城","墨西哥城"],
    "巴西": ["巴西","Brazil","BR","巴西利亞","巴西利亚","里約","里约","聖保羅","圣保罗"],
    "阿根廷": ["阿根廷","Argentina","AR","布宜諾斯艾利斯","布宜诺斯艾利斯"],
    "智利": ["智利","Chile","CL","聖地牙哥","圣地亚哥"],
    "秘魯": ["秘魯","秘鲁","Peru","PE","利馬","利马"],
    "哥倫比亞": ["哥倫比亞","哥伦比亚","Colombia","CO","波哥大"],
    "委內瑞拉": ["委內瑞拉","委内瑞拉","Venezuela","VE","卡拉卡斯"],
    "厄瓜多": ["厄瓜多","厄瓜多尔","Ecuador","EC","基多"],
    "玻利維亞": ["玻利維亞","玻利维亚","Bolivia","BO","拉巴斯","蘇克雷","苏克雷"],
    "烏拉圭": ["烏拉圭","乌拉圭","Uruguay","UY","蒙得維的亞","蒙得维的亚"],
    "巴拉圭": ["巴拉圭","Paraguay","PY","亞松森","亚松森"],
    "古巴": ["古巴","Cuba","CU","哈瓦那"],
    "多明尼加": ["多明尼加","多米尼加","DominicanRepublic","DO","聖多明各","圣多明各"],
    "海地": ["海地","Haiti","HT","太子港"],
    "瓜地馬拉": ["瓜地馬拉","危地马拉","瓜地马拉","Guatemala","GT"],
    "薩爾瓦多": ["薩爾瓦多","萨尔瓦多","ElSalvador","SV","聖薩爾瓦多","圣萨尔瓦多"],
    "宏都拉斯": ["宏都拉斯","洪都拉斯","Honduras","HN","德古西加巴"],
    "尼加拉瓜": ["尼加拉瓜","Nicaragua","NI","馬那瓜","马那瓜"],
    "哥斯大黎加": ["哥斯大黎加","CostaRica","CR","聖荷西","圣何塞"],
    "巴拿馬": ["巴拿馬","巴拿马","Panama","PA","巴拿馬城","巴拿马城"],
    "牙買加": ["牙買加","牙买加","Jamaica","JM","金斯敦"],
    "巴貝多": ["巴貝多","巴巴多斯","Barbados","BB"],
    "千里達及托巴哥": ["千里達及托巴哥","特立尼达和多巴哥","TrinidadandTobago","TT","西班牙港"],
    "巴哈馬": ["巴哈馬","巴哈马","Bahamas","BS","拿騷","拿骚"],

    # 非洲
    "南非": ["南非","SouthAfrica","ZA","比勒陀利亞","约翰内斯堡","開普敦","开普敦"],
    "奈及利亞": ["奈及利亞","尼日利亚","Nigeria","NG","阿布加"],
    "衣索比亞": ["衣索比亞","埃塞俄比亚","Ethiopia","ET","亞的斯亞貝巴","亚的斯亚贝巴"],
    "肯亞": ["肯亞","肯尼亚","Kenya","KE","奈洛比","内罗毕"],
    "坦尚尼亞": ["坦尚尼亞","坦桑尼亚","Tanzania","TZ","多多馬","多多马","達累斯薩拉姆","达累斯萨拉姆"],
    "烏干達": ["烏干達","乌干达","Uganda","UG","坎帕拉"],
    "盧安達": ["盧安達","卢旺达","Rwanda","RW","吉佳利","基加利"],
    "迦納": ["迦納","加纳","Ghana","GH","阿克拉"],
    "象牙海岸": ["象牙海岸","科特迪瓦","CoteDIvoire","Côted’Ivoire","CI","阿比讓","阿比让"],
    "塞內加爾": ["塞內加爾","塞内加尔","Senegal","SN","達喀爾","达喀尔"],
    "喀麥隆": ["喀麥隆","喀麦隆","Cameroon","CM","雅溫得","雅温得"],
    "摩洛哥": ["摩洛哥","Morocco","MA","拉巴特","卡薩布蘭卡","卡萨布兰卡"],
    "阿爾及利亞": ["阿爾及利亞","阿尔及利亚","Algeria","DZ","阿爾及爾","阿尔及尔"],
    "突尼西亞": ["突尼西亞","突尼斯","Tunisia","TN","突尼斯市"],
    "利比亞": ["利比亞","利比亚","Libya","LY","的黎波里"],
    "蘇丹": ["蘇丹","苏丹","Sudan","SD","喀土穆"],
    "南蘇丹": ["南蘇丹","南苏丹","SouthSudan","SS","朱巴"],
    "索馬利亞": ["索馬利亞","索马里","Somalia","SO","摩加迪休"],
    "安哥拉": ["安哥拉","Angola","AO","羅安達","罗安达"],
    "納米比亞": ["納米比亞","纳米比亚","Namibia","NA","溫得和克","温得和克"],
    "波札那": ["波札那","博茨瓦纳","Botswana","BW","嘉博羅內","哈博罗内"],
    "尚比亞": ["尚比亞","赞比亚","Zambia","ZM","路沙卡","卢萨卡"],
    "辛巴威": ["辛巴威","津巴布韋","津巴布韦","Zimbabwe","ZW","哈拉雷"],
    "剛果民主共和國": ["剛果民主共和國","刚果（金）","刚果民主共和国","DRC","Congo-Kinshasa","DemocraticRepublicofCongo"],
    "剛果共和國": ["剛果共和國","刚果（布）","刚果共和国","Congo-Brazzaville","RepublicofCongo"],
    "馬達加斯加": ["馬達加斯加","马达加斯加","Madagascar","MG","塔那那利佛"],
    "模里西斯": ["模里西斯","毛里求斯","Mauritius","MU","路易港"],

    # 大洋洲與太平洋島國
    "帛琉": ["帛琉","帕劳","Palau","PW"],
    "所羅門群島": ["所羅門群島","所罗门群岛","SolomonIslands","SB","荷尼阿拉"],
    "馬紹爾群島": ["馬紹爾群島","马绍尔群岛","MarshallIslands","MH","馬久羅","马朱罗"],
    "吐瓦魯": ["吐瓦魯","图瓦卢","Tuvalu","TV","富那富提"],
    "諾魯": ["諾魯","瑙鲁","Nauru","NR"],
    "吉里巴斯": ["吉里巴斯","基里巴斯","Kiribati","KI","塔拉瓦"],
    "密克羅尼西亞聯邦": ["密克羅尼西亞聯邦","密克罗尼西亚","Micronesia","FederatedStatesofMicronesia","FSM"],
    "巴布亞紐幾內亞": ["巴布亞紐幾內亞","巴布亚新几内亚","PapuaNewGuinea","PNG"],
    "斐濟": ["斐濟","斐济","Fiji","FJ","蘇瓦","苏瓦"],
    "薩摩亞": ["薩摩亞","萨摩亚","Samoa","WS","阿皮亞","阿皮亚"],
    "東加": ["東加","汤加","Tonga","TO","努瓜婁發","努库阿洛法"],
    "萬那杜": ["萬那杜","瓦努阿图","Vanuatu","VU","維拉港","维拉港"],
}

# 編譯 alias regex（大小寫不敏感，中文精確片段，英文常見縮寫也支援）
_ALIAS_PATTERNS: Dict[str, List[re.Pattern]] = {}
for canon, aliases in COUNTRY_OR_REGION_ALIASES.items():
    pats = []
    for a in aliases:
        a_norm = _cjk_norm(a)
        if not a_norm:
            continue
        # 對英文字母與縮寫，提供邊界更嚴格的寫法；中文以子字串即可
        if re.search(r"[A-Za-z]", a_norm):
            pats.append(re.compile(rf"(?i)(?<![A-Za-z0-9]){re.escape(a_norm)}(?![A-Za-z0-9])"))
        else:
            pats.append(re.compile(re.escape(a_norm)))
    _ALIAS_PATTERNS[canon] = pats

# 針對極常見語境補強的關鍵字（避免寫太多 alias）
_SUPPLEMENTAL_KEYWORD_PATTERNS: Dict[str, List[re.Pattern]] = {
    "美國": [re.compile(r"白宮|華府|美軍|矽谷|加州|德州|佛州|紐約|洛杉磯|舊金山|西雅圖|波士頓|芝加哥|華盛頓")],
    "中國": [re.compile(r"北京|上海|天津|重慶|廣東|深圳|廣州|福建|浙江|江蘇|山東|河北|河南|湖南|湖北|江西|安徽|山西|陝西|四川|雲南|貴州|遼寧|吉林|黑龍江|甘肅|青海|內蒙古|寧夏|新疆|西藏|海南|廣西|蘇州|南京|合肥|青島|哈爾濱|廈門|武漢|成都")],
    "以色列": [re.compile(r"特拉維夫|耶路撒冷|海法")],
    "烏克蘭": [re.compile(r"基輔|哈爾科夫|敖德薩|赫爾松|頓涅茨克|盧甘斯克")],
    "歐盟": [re.compile(r"布魯塞爾|歐盟委員會|歐洲議會|EU", re.I)],
    "約旦河西岸": [re.compile(r"約旦河西岸|西岸|WestBank", re.I)],
    "加沙": [re.compile(r"加薩|加沙", re.I)],
}

# ---- 台灣區域別稱 → 標準大區 ----
TAIWAN_REGION_ALIAS_TO_CANON: Dict[str, str] = {
    # 北部
    "北臺灣": "台灣-北部", "北台灣": "台灣-北部", "北部": "台灣-北部",
    "北部沿海": "台灣-北部", "大台北": "台灣-北部", "北北基": "台灣-北部",
    # 中部
    "中臺灣": "台灣-中部", "中台灣": "台灣-中部", "中部": "台灣-中部", "桃竹苗": "台灣-中部",
    # 南部
    "南臺灣": "台灣-南部", "南台灣": "台灣-南部", "南部": "台灣-南部",
    "高屏": "台灣-南部", "雲嘉南": "台灣-南部",
    # 東部
    "東臺灣": "台灣-東部", "東台灣": "台灣-東部", "東部": "台灣-東部",
    "花東": "台灣-花東", "花東地區": "台灣-花東",
    # 西部與離島
    "西部": "台灣-西部",
    "離島": "台灣-離島",
}

# 區域 → enum 內的縣市展開
REGION_TO_ENUMS: Dict[str, List[str]] = {
    "台灣-北部": ["台北市","新北市","基隆市","桃園市","新竹市","新竹縣","宜蘭縣"],
    "台灣-中部": ["台中市","苗栗縣","彰化縣","南投縣","雲林縣"],
    "台灣-南部": ["台南市","高雄市","屏東縣","嘉義縣","嘉義市","雲林縣"],
    "台灣-東部": ["宜蘭縣","花蓮縣","台東縣"],
    "台灣-西部": [
        "基隆市","台北市","新北市","桃園市","新竹市","新竹縣",
        "苗栗縣","台中市","彰化縣","南投縣","雲林縣","嘉義縣","嘉義市",
        "台南市","高雄市","屏東縣"
    ],
    "台灣-花東": ["花蓮縣","台東縣"],
    "台灣-離島": ["澎湖縣","金門縣","連江縣"],
}

# 預先編譯區域別稱 regex（長詞優先，避免「北部沿海」被「北部」搶先）
_REGION_ALIAS_PATTERN = re.compile("|".join(
    sorted(map(re.escape, TAIWAN_REGION_ALIAS_TO_CANON.keys()), key=len, reverse=True)
))

# ---- 主對外 API：單一字串 → 單一地點（enum）或 None ----
def canonicalize_place(raw: str) -> Optional[str]:
    s = _cjk_norm(raw)

    # 完整命中白名單（與 enum 完全對齊）
    if s in ALLOWED_PLACES:
        return s

    # 台灣縣市（關鍵詞）
    for label, pats in TW_PATTERNS.items():
        if any(p.search(s) for p in pats):
            return label

    # 先用 alias 命中（含英文/縮寫）
    for canon, pats in _ALIAS_PATTERNS.items():
        if any(p.search(s) for p in pats):
            if canon in ALLOWED_PLACES:
                return canon

    # 補強關鍵字（地名/政府機關/城市）
    for canon, pats in _SUPPLEMENTAL_KEYWORD_PATTERNS.items():
        if any(p.search(s) for p in pats):
            if canon in ALLOWED_PLACES:
                return canon

    # 區域別稱在 expand helper 中展開；此處不回傳區域
    return None

# ---- 從 tokens + 原文 text 展開到 enum 集合 ----
def expand_tokens_to_allowed_places(tokens: Optional[List[str]] = None, text: Optional[str] = None) -> Set[str]:
    """
    將 NER/規則抽到的 tokens 與全文 text 共同解析，輸出對齊 ALLOWED_PLACES 的集合。
    - 會處理：台灣縣市、國家/地區（含別名/縮寫）、區域別稱（展開成多個縣市）、常見細地名關鍵詞。
    - 不做預設回退（台灣/國際），讓上游邏輯自行決定。
    """
    out: Set[str] = set()
    tokens = tokens or []
    norm_tokens = [_cjk_norm(t) for t in tokens if t]

    # 1) 逐一嘗試台灣縣市/國家/地區歸一
    for t in norm_tokens:
        c = canonicalize_place(t)
        if c:
            out.add(c)

    # 2) 區域別稱（從 tokens 與全文 text 同時偵測）→ 展開到縣市
    region_hits: Set[str] = set()
    for t in norm_tokens:
        for m in _REGION_ALIAS_PATTERN.finditer(t):
            alias = m.group(0)
            region_hits.add(TAIWAN_REGION_ALIAS_TO_CANON[alias])
    if text:
        s_full = _cjk_norm(text)
        for m in _REGION_ALIAS_PATTERN.finditer(s_full):
            alias = m.group(0)
            region_hits.add(TAIWAN_REGION_ALIAS_TO_CANON[alias])

    for region in region_hits:
        for county in REGION_TO_ENUMS.get(region, []):
            if county in ALLOWED_PLACES:
                out.add(county)

    # 3) 細地名 → 縣市（台灣補強）
    if text:
        s_full = _cjk_norm(text)
        for pat, county in TW_KEYWORD_TO_COUNTY:
            if pat.search(s_full) and county in ALLOWED_PLACES:
                out.add(county)
        # 額外處理「花東」
        if re.search(r"花東", s_full):
            out.update({"花蓮縣", "台東縣"})

        # 4) 全文掃描 alias 與補強關鍵字（避免 NER 漏抓）
        for canon, pats in _ALIAS_PATTERNS.items():
            if any(p.search(s_full) for p in pats):
                if canon in ALLOWED_PLACES:
                    out.add(canon)
        for canon, pats in _SUPPLEMENTAL_KEYWORD_PATTERNS.items():
            if any(p.search(s_full) for p in pats):
                if canon in ALLOWED_PLACES:
                    out.add(canon)

    return out